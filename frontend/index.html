<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿å‹™æ´»å‹•è²» è²»ç›®åˆ†åˆ¥ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; color: #333; }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .navbar { background-color: #ffffff; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0; }
        .logo { display: flex; align-items: center; font-size: 1.2rem; font-weight: bold; color: #333; }
        .logo span { margin-left: 10px; }
        
        /* è²¡å‹™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ï¼ˆæ–°æ©Ÿèƒ½ï¼‰ */
        .status-bar {
            background: #2c3e50; color: white; padding: 15px; text-align: center;
            display: flex; justify-content: center; gap: 40px; font-size: 1.1rem;
        }
        .status-item span { font-size: 0.9rem; opacity: 0.8; margin-right: 5px; }
        .status-item strong { font-size: 1.3rem; font-weight: bold; }
        .balance-plus { color: #4cd137; } /* ãƒ—ãƒ©ã‚¹ãªã‚‰ç·‘ */
        .balance-minus { color: #e74c3c; } /* ãƒã‚¤ãƒŠã‚¹ãªã‚‰èµ¤ */

        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; text-align: center; }
        h1 { margin-bottom: 10px; font-size: 2rem; }
        .subtitle { color: #666; margin-bottom: 40px; }

        /* ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .card { background: white; padding: 30px 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s; text-align: left; display: flex; flex-direction: column; justify-content: space-between; min-height: 200px; }
        .card:hover { transform: translateY(-5px); }
        .icon-box { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 15px; }
        .bg-blue { background-color: #e3f2fd; color: #1976d2; }
        .bg-green { background-color: #e8f5e9; color: #388e3c; }
        .bg-purple { background-color: #f3e5f5; color: #7b1fa2; }
        .bg-orange { background-color: #fff3e0; color: #f57c00; }

        .btn { display: block; text-align: center; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; border: 1px solid #ddd; background: white; color: #333; width: 100%; margin-top: 10px;}
        .btn-primary { background-color: #2563eb; color: white; border: none; }
        .btn-primary:hover { background-color: #1d4ed8; }

        /* å„ç”»é¢ */
        .view-section { display: none; background: white; padding: 30px; border-radius: 12px; text-align: left; margin-top: 20px; }
        .back-btn { margin-bottom: 20px; cursor: pointer; color: #2563eb; text-decoration: underline; background: none; border: none; }

        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .upload-area { border: 2px dashed #ccc; padding: 40px; text-align: center; border-radius: 10px; cursor: pointer; }
        .upload-area:hover { background-color: #fafafa; border-color: #2563eb; }

        /* è¨­å®šãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
    </style>
</head>
<body onload="loadStatus()">

    <div class="navbar">
        <div class="logo"><span style="background:#2563eb; color:white; padding:5px; border-radius:5px;">ğŸ§¾</span><span>æ”¿å‹™æ´»å‹•è²»ã‚¢ãƒ—ãƒª</span></div>
        <div style="font-size:0.9rem;">KENTARO TAKAHASHI</div>
    </div>

    <div class="status-bar">
        <div class="status-item">
            <span>ä»Šå¹´åº¦ åå…¥:</span> <strong id="dispIncome">0</strong> å††
        </div>
        <div class="status-item">
            <span>æ”¯å‡ºè¨ˆ(æ¦‚ç®—):</span> <strong id="dispExpenses">0</strong> å††
        </div>
        <div class="status-item">
            <span>æ®‹é¡:</span> <strong id="dispBalance" class="balance-plus">0</strong> å††
        </div>
    </div>

    <div class="container" id="dashboard">
        <h1>æ”¿å‹™æ´»å‹•è²»ã®ç®¡ç†ã‚’ç°¡å˜ã«</h1>
        <p class="subtitle">ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã ã‘ã§ã€è‡ªå‹•çš„ã«è²»ç›®ã‚’åˆ†åˆ¥ã—ã€é›†è¨ˆçµæœã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>

        <div class="grid">
            <div class="card">
                <div><div class="icon-box bg-blue">ğŸ“¤</div><h3>ãƒ¬ã‚·ãƒ¼ãƒˆç™»éŒ²</h3><p>ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</p></div>
                <button class="btn btn-primary" onclick="showView('upload-view')">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            </div>
            <div class="card">
                <div><div class="icon-box bg-green">ğŸ“„</div><h3>ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§</h3><p>ç™»éŒ²æ¸ˆã¿ã®ç”»åƒã‚’ç¢ºèªã—ã¾ã™ã€‚</p></div>
                <button class="btn" onclick="showView('list-view')">ä¸€è¦§ã‚’è¦‹ã‚‹</button>
            </div>
            <div class="card">
                <div><div class="icon-box bg-purple">ğŸ“Š</div><h3>é›†è¨ˆçµæœ</h3><p>è²»ç›®ã”ã¨ã®åˆè¨ˆã‚’ç¢ºèªã—ã¾ã™ã€‚</p></div>
                <button class="btn" onclick="showView('summary-view')">é›†è¨ˆã‚’è¦‹ã‚‹</button>
            </div>
            <div class="card">
                <div><div class="icon-box bg-orange">âš™ï¸</div><h3>è¨­å®šãƒ»åŸºæº–ç®¡ç†</h3><p>åå…¥è¨­å®šã‚„æŒ‰åˆ†åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã—ã¾ã™ã€‚</p></div>
                <button class="btn" onclick="showView('settings-view')">è¨­å®šã‚’é–‹ã</button>
            </div>
        </div>
    </div>

    <div class="container view-section" id="upload-view">
        <button class="back-btn" onclick="showDashboard()">â† æˆ»ã‚‹</button>
        <h2>ğŸ“¤ ãƒ¬ã‚·ãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <p>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠã€ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</p>
            <input type="file" id="fileInput" accept="image/*" style="display: none" onchange="uploadReceipt()">
        </div>
        <div id="uploadResult" style="margin-top: 20px; font-weight: bold;"></div>
    </div>

    <div class="container view-section" id="list-view">
        <button class="back-btn" onclick="showDashboard()">â† æˆ»ã‚‹</button>
        <h2>ğŸ“„ ç™»éŒ²æ¸ˆã¿ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§</h2>
        <div id="gallery" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="container view-section" id="summary-view">
        <button class="back-btn" onclick="showDashboard()">â† æˆ»ã‚‹</button>
        <h2>ğŸ“Š æ”¯å‡ºé›†è¨ˆï¼ˆãƒ‡ãƒ¢ï¼‰</h2>
        <canvas id="expenseChart"></canvas>
    </div>

    <div class="container view-section" id="settings-view">
        <button class="back-btn" onclick="showDashboard()">â† æˆ»ã‚‹</button>
        <h2>âš™ï¸ è¨­å®šãƒ»åŸºæº–ç®¡ç†</h2>
        
        <div style="background:#f9f9f9; padding:20px; border-radius:10px; margin-bottom:20px;">
            <h3>ğŸ’° åå…¥ï¼ˆæ”¿å‹™æ´»å‹•è²» äºˆç®—ï¼‰ã®è¨­å®š</h3>
            <div class="form-group">
                <label>ä»Šå¹´åº¦ã®å—å…¥é¡ (å††)</label>
                <input type="number" id="incomeInput" placeholder="ä¾‹: 6000000">
            </div>
            <button class="btn btn-primary" onclick="saveIncome()">ä¿å­˜ã™ã‚‹</button>
        </div>

        <div style="background:#f9f9f9; padding:20px; border-radius:10px;">
            <h3>ğŸ“‘ æŒ‰åˆ†åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã®ç™»éŒ²</h3>
            <p style="font-size:0.9rem; color:#666;">ç¾åœ¨ç™»éŒ²ä¸­: <strong id="currentCriteria">æœªè¨­å®š</strong></p>
            <div class="form-group">
                <label>æ–°ã—ã„åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (CSV, PDFãªã©)</label>
                <input type="file" id="criteriaInput">
            </div>
            <button class="btn btn-primary" onclick="uploadCriteria()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ›´æ–°</button>
        </div>
    </div>

    <script>
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆåå…¥ãƒ»æ®‹é«˜ï¼‰èª­ã¿è¾¼ã¿
        async function loadStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                
                document.getElementById('dispIncome').innerText = data.income.toLocaleString();
                document.getElementById('dispExpenses').innerText = data.expenses.toLocaleString();
                
                const balEl = document.getElementById('dispBalance');
                balEl.innerText = data.balance.toLocaleString();
                balEl.className = data.balance >= 0 ? "balance-plus" : "balance-minus";

                // è¨­å®šç”»é¢ã®è¡¨ç¤ºã‚‚æ›´æ–°
                document.getElementById('incomeInput').value = data.income;
                document.getElementById('currentCriteria').innerText = data.criteria_file;

            } catch(e) { console.error(e); }
        }

        // åå…¥ã‚’ä¿å­˜
        async function saveIncome() {
            const val = document.getElementById('incomeInput').value;
            const formData = new FormData();
            formData.append('income', val);
            await fetch('/api/settings/income', { method: 'POST', body: formData });
            alert("åå…¥ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
            loadStatus(); // è¡¨ç¤ºæ›´æ–°
        }

        // åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadCriteria() {
            const file = document.getElementById('criteriaInput').files[0];
            if(!file) return;
            const formData = new FormData();
            formData.append('file', file);
            await fetch('/api/settings/criteria', { method: 'POST', body: formData });
            alert("åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
            loadStatus();
        }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆãªã©æ—¢å­˜æ©Ÿèƒ½
        function showView(id) {
            document.getElementById('dashboard').style.display = 'none';
            document.querySelectorAll('.view-section').forEach(e => e.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'list-view') loadHistory();
            if(id === 'summary-view') renderChart();
        }
        function showDashboard() {
            document.querySelectorAll('.view-section').forEach(e => e.style.display = 'none');
            document.getElementById('dashboard').style.display = 'block';
            loadStatus(); // æˆ»ã£ãŸæ™‚ã«æœ€æ–°æƒ…å ±ã‚’å†å–å¾—
        }
        
        async function uploadReceipt() { /* (æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨åŒã˜) */ 
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) return;
            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            document.getElementById('uploadResult').innerText = "â³ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...";
            try {
                const res = await fetch('/api/ocr/upload', { method: 'POST', body: formData });
                if(res.ok) {
                    const data = await res.json();
                    document.getElementById('uploadResult').innerText = "âœ… ä¿å­˜æˆåŠŸ: " + data.filename;
                    loadStatus(); // ãƒ•ã‚¡ã‚¤ãƒ«æ•°ãŒå¢—ãˆãŸã®ã§æ”¯å‡ºï¼ˆä»®ï¼‰ã‚’æ›´æ–°
                }
            } catch(e) { document.getElementById('uploadResult').innerText = "âŒ ã‚¨ãƒ©ãƒ¼"; }
        }

        async function loadHistory() { /* (æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨åŒã˜) */
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
            const res = await fetch('/api/ocr/list');
            const data = await res.json();
            gallery.innerHTML = "";
            data.files.forEach(file => {
                const div = document.createElement('div');
                div.innerHTML = `<a href="/uploads/${file}" target="_blank"><img src="/uploads/${file}" style="width:100%; border-radius:5px;"></a>`;
                gallery.appendChild(div);
            });
        }

        function renderChart() { /* (æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨åŒã˜) */
            const ctx = document.getElementById('expenseChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['èª¿æŸ»ç ”ç©¶è²»', 'ç ”ä¿®è²»', 'åºƒè´åºƒå ±è²»', 'ä¼šè­°è²»', 'è³‡æ–™ä½œæˆè²»'],
                    datasets: [{ label: 'æ”¯å‡ºé¡ (å††)', data: [12000, 5000, 30000, 1500, 20000], backgroundColor: '#2563eb' }]
                }
            });
        }
    </script>
</body>
</html>
