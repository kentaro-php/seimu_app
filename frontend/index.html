<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¿å‹™æ´»å‹•è²» è²»ç›®åˆ†åˆ¥ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f4f7f6; margin: 0; padding: 0; color: #333; }
        
        /* åŸºæœ¬UI */
        .navbar { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        .status-bar { background: #2c3e50; color: white; padding: 15px; text-align: center; display: flex; justify-content: center; gap: 40px; }
        .status-item strong { font-size: 1.3rem; }
        .balance-plus { color: #4cd137; } .balance-minus { color: #e74c3c; }

        .container { max-width: 1000px; margin: 30px auto; padding: 0 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top:30px;}
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.2s; text-align: left; }
        .card:hover { transform: translateY(-3px); }
        .icon-box { width: 45px; height: 45px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-bottom: 15px; }
        .bg-blue { background: #e3f2fd; color: #1565c0; } .bg-green { background: #e8f5e9; color: #2e7d32; }
        .bg-purple { background: #f3e5f5; color: #7b1fa2; } .bg-orange { background: #fff3e0; color: #ef6c00; }

        .btn { display: block; width: 100%; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; border: 1px solid #ddd; background: white; margin-top: 15px; }
        .btn-primary { background: #2563eb; color: white; border: none; }
        .btn-primary:hover { background: #1d4ed8; }

        .view-section { display: none; background: white; padding: 30px; border-radius: 12px; margin-top: 20px; }
        .back-btn { cursor: pointer; color: #2563eb; text-decoration: underline; background: none; border: none; margin-bottom: 15px; }

        /* ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚¹ã‚¿ã‚¤ãƒ« */
        .receipt-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .receipt-item { border: 1px solid #eee; border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.2s; background: #fff; }
        .receipt-item:hover { transform: scale(1.03); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .receipt-item img { width: 100%; height: 120px; object-fit: cover; }
        .receipt-meta { padding: 8px; font-size: 0.8rem; }
        .receipt-amount { font-weight: bold; color: #333; font-size: 1rem; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè©³ç´°ç·¨é›†ç”»é¢ï¼‰ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: white; width: 90%; max-width: 800px; max-height: 90vh; border-radius: 12px; display: flex; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-left { flex: 1; background: #333; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-left img { max-width: 100%; max-height: 100%; border-radius: 5px; }
        .modal-right { flex: 1; padding: 30px; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    </style>
</head>
<body onload="initApp()">

    <div class="navbar">
        <div style="font-weight:bold; font-size:1.2rem;">ğŸ§¾ æ”¿å‹™æ´»å‹•è²»ã‚¢ãƒ—ãƒª</div>
        <div>KENTARO TAKAHASHI</div>
    </div>

    <div class="status-bar">
        <div>åå…¥: <strong id="dispIncome">0</strong> å††</div>
        <div>æ”¯å‡º: <strong id="dispExpenses">0</strong> å††</div>
        <div>æ®‹é¡: <strong id="dispBalance">0</strong> å††</div>
    </div>

    <div class="container" id="dashboard">
        <div class="grid">
            <div class="card">
                <div><div class="icon-box bg-blue">ğŸ“¤</div><h3>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3><p>ãƒ¬ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚</p></div>
                <button class="btn btn-primary" onclick="showView('upload-view')">ç™»éŒ²ã™ã‚‹</button>
            </div>
            <div class="card">
                <div><div class="icon-box bg-green">ğŸ“„</div><h3>ä¸€è¦§ãƒ»ç·¨é›†</h3><p>ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªãƒ»ä¿®æ­£ã‚’è¡Œã„ã¾ã™ã€‚</p></div>
                <button class="btn" onclick="showView('list-view')">ä¸€è¦§ã‚’è¦‹ã‚‹</button>
            </div>
            <div class="card">
                <div><div class="icon-box bg-purple">ğŸ“Š</div><h3>é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆ</h3><p>è²»ç›®åˆ¥ã®å‰²åˆã‚’ç¢ºèªã—ã¾ã™ã€‚</p></div>
                <button class="btn" onclick="showView('summary-view')">ã‚°ãƒ©ãƒ•ã‚’è¦‹ã‚‹</button>
            </div>
            <div class="card">
                <div><div class="icon-box bg-orange">âš™ï¸</div><h3>è¨­å®š</h3><p>åå…¥ã‚„åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®šã—ã¾ã™ã€‚</p></div>
                <button class="btn" onclick="showView('settings-view')">è¨­å®š</button>
            </div>
        </div>
    </div>

    <div class="container view-section" id="upload-view">
        <button class="back-btn" onclick="showDashboard()">æˆ»ã‚‹</button>
        <h2>ğŸ“¤ ãƒ¬ã‚·ãƒ¼ãƒˆç™»éŒ²</h2>
        <div style="border: 2px dashed #ccc; padding: 50px; text-align: center; border-radius: 10px; cursor: pointer;" onclick="document.getElementById('fileInput').click()">
            <p>ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’é¸æŠ</p>
            <input type="file" id="fileInput" accept="image/*" style="display: none" onchange="uploadReceipt()">
        </div>
    </div>

    <div class="container view-section" id="list-view">
        <button class="back-btn" onclick="showDashboard()">æˆ»ã‚‹</button>
        <h2>ğŸ“„ ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§</h2>
        <div id="gallery" class="receipt-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div class="container view-section" id="summary-view">
        <button class="back-btn" onclick="showDashboard()">æˆ»ã‚‹</button>
        <h2>ğŸ“Š è²»ç›®åˆ¥é›†è¨ˆ</h2>
        <canvas id="expenseChart" style="max-height:400px;"></canvas>
    </div>

    <div class="container view-section" id="settings-view">
        <button class="back-btn" onclick="showDashboard()">æˆ»ã‚‹</button>
        <h2>âš™ï¸ è¨­å®š</h2>
        <div class="form-group">
            <label>ä»Šå¹´åº¦ åå…¥ (å††)</label>
            <input type="number" id="incomeInput">
            <button class="btn btn-primary" onclick="saveIncome()">ä¿å­˜</button>
        </div>
        <hr>
        <div class="form-group">
            <label>æŒ‰åˆ†åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ« (ç¾åœ¨: <span id="currentCriteria"></span>)</label>
            <input type="file" id="criteriaInput">
            <button class="btn btn-primary" onclick="uploadCriteria()">æ›´æ–°</button>
        </div>
    </div>

    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-left">
                <img id="modalImage" src="">
            </div>
            <div class="modal-right">
                <h3>ğŸ“ è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®ç·¨é›†</h3>
                <input type="hidden" id="modalFilename">
                
                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <input type="date" id="modalDate">
                </div>
                <div class="form-group">
                    <label>æ”¯æ‰•é‡‘é¡ (å††)</label>
                    <input type="number" id="modalAmount" placeholder="ä¾‹: 1500">
                </div>
                <div class="form-group">
                    <label>åº—å</label>
                    <input type="text" id="modalStore" placeholder="ä¾‹: ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³">
                </div>
                <div class="form-group">
                    <label>è²»ç›®ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                    <select id="modalCategory">
                        <option value="æœªåˆ†é¡">æœªåˆ†é¡</option>
                        <option value="èª¿æŸ»ç ”ç©¶è²»">èª¿æŸ»ç ”ç©¶è²»</option>
                        <option value="ç ”ä¿®è²»">ç ”ä¿®è²»</option>
                        <option value="åºƒè´åºƒå ±è²»">åºƒè´åºƒå ±è²»</option>
                        <option value="è¦è«‹é™³æƒ…ç­‰æ´»å‹•è²»">è¦è«‹é™³æƒ…ç­‰æ´»å‹•è²»</option>
                        <option value="ä¼šè­°è²»">ä¼šè­°è²»</option>
                        <option value="è³‡æ–™ä½œæˆè²»">è³‡æ–™ä½œæˆè²»</option>
                        <option value="è³‡æ–™è³¼å…¥è²»">è³‡æ–™è³¼å…¥è²»</option>
                        <option value="äººä»¶è²»">äººä»¶è²»</option>
                        <option value="äº‹å‹™æ‰€è²»">äº‹å‹™æ‰€è²»</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ãƒ¡ãƒ¢ (æŒ‰åˆ†ç‡ãªã©)</label>
                    <textarea id="modalNote" rows="3"></textarea>
                </div>

                <button class="btn btn-primary" onclick="saveReceiptDetails()">ä¿å­˜ã—ã¦é–‰ã˜ã‚‹</button>
                <button class="btn" style="color:red; border-color:red;" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        // --- åˆæœŸåŒ– & ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
        function initApp() {
            loadStatus();
        }

        async function loadStatus() {
            const res = await fetch('/api/status');
            const data = await res.json();
            
            document.getElementById('dispIncome').innerText = data.income.toLocaleString();
            document.getElementById('dispExpenses').innerText = data.expenses.toLocaleString();
            const bal = document.getElementById('dispBalance');
            bal.innerText = data.balance.toLocaleString();
            bal.className = data.balance >= 0 ? "balance-plus" : "balance-minus";

            document.getElementById('incomeInput').value = data.income;
            document.getElementById('currentCriteria').innerText = data.criteria_file;
        }

        // --- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†ï¼ˆAIè§£æå¯¾å¿œï¼‰ ---
        async function uploadReceipt() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append("file", file);

            // â˜…ã“ã“ãŒAIã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼
            alert("ğŸ¤– AIãŒãƒ¬ã‚·ãƒ¼ãƒˆã‚’è§£æã—ã¦ã„ã¾ã™...\nï¼ˆ10ç§’ã»ã©ãŠå¾…ã¡ãã ã•ã„ï¼‰");

            try {
                const res = await fetch('/api/ocr/upload', { method: 'POST', body: formData });
                const json = await res.json();
                
                if(json.status === "success") {
                    const data = json.data;
                    document.getElementById('fileInput').value = ""; // ãƒªã‚»ãƒƒãƒˆ
                    
                    // ä¸€è¦§ç”»é¢ã¸ç§»å‹•ã—ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                    showView('list-view');
                    openModal(data);
                    
                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    alert(`âœ… è§£æå®Œäº†ï¼\n\nåº—å: ${data.store}\né‡‘é¡: ${data.amount}å††\nè²»ç›®: ${data.category}\n\nå†…å®¹ã‚’ç¢ºèªãƒ»ä¿®æ­£ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚`);
                }
            } catch(e) { 
                console.error(e);
                alert("âŒ è§£æã«å¤±æ•—ã—ã¾ã—ãŸ"); 
            }
        }

        // --- ä¸€è¦§è¡¨ç¤ºå‡¦ç† ---
        async function loadList() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
            const res = await fetch('/api/ocr/list');
            const data = await res.json();
            gallery.innerHTML = "";

            data.files.forEach(item => {
                const div = document.createElement('div');
                div.className = 'receipt-item';
                div.onclick = () => openModal(item);
                div.innerHTML = `
                    <img src="/uploads/${item.filename}">
                    <div class="receipt-meta">
                        <div class="receipt-amount">Â¥${item.amount.toLocaleString()}</div>
                        <div style="color:#666;">${item.category}</div>
                        <div style="font-size:0.7rem; color:#999;">${item.date}</div>
                    </div>
                `;
                gallery.appendChild(div);
            });
            updateChart(data.files);
        }

        // --- ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ ---
        function openModal(item) {
            document.getElementById('modalFilename').value = item.filename;
            document.getElementById('modalImage').src = "/uploads/" + item.filename;
            document.getElementById('modalAmount').value = item.amount;
            document.getElementById('modalCategory').value = item.category;
            document.getElementById('modalDate').value = item.date;
            document.getElementById('modalStore').value = item.store || "";
            document.getElementById('modalNote').value = item.note || "";
            
            document.getElementById('detailModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        async function saveReceiptDetails() {
            const filename = document.getElementById('modalFilename').value;
            const payload = {
                date: document.getElementById('modalDate').value,
                amount: parseInt(document.getElementById('modalAmount').value) || 0,
                store: document.getElementById('modalStore').value,
                category: document.getElementById('modalCategory').value,
                note: document.getElementById('modalNote').value
            };

            await fetch(`/api/receipts/${filename}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            closeModal();
            loadStatus(); // æ®‹é¡æ›´æ–°
            loadList();   // ä¸€è¦§ãƒ»ã‚°ãƒ©ãƒ•æ›´æ–°
        }

        // --- ã‚°ãƒ©ãƒ•æ›´æ–° ---
        function updateChart(files) {
            // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«é›†è¨ˆ
            const totals = {};
            files.forEach(f => {
                totals[f.category] = (totals[f.category] || 0) + f.amount;
            });

            const labels = Object.keys(totals);
            const data = Object.values(totals);

            const ctx = document.getElementById('expenseChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#3498db', '#e74c3c', '#f1c40f', '#2ecc71', '#9b59b6', '#34495e']
                    }]
                }
            });
        }

        // --- ç”»é¢åˆ‡ã‚Šæ›¿ãˆ ---
        function showDashboard() {
            document.getElementById('dashboard').style.display = 'block';
            document.querySelectorAll('.view-section').forEach(e => e.style.display = 'none');
            loadStatus();
        }
        function showView(id) {
            document.getElementById('dashboard').style.display = 'none';
            document.querySelectorAll('.view-section').forEach(e => e.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if(id === 'list-view') loadList();
            if(id === 'summary-view') loadList(); // ãƒ‡ãƒ¼ã‚¿å–å¾—ã®ãŸã‚ã«ä¸€è¦§å‡¦ç†ã‚’å‘¼ã¶
        }

        // --- è¨­å®šä¿å­˜ç³» ---
        async function saveIncome() {
            const val = document.getElementById('incomeInput').value;
            const formData = new FormData();
            formData.append('income', val);
            await fetch('/api/settings/income', { method: 'POST', body: formData });
            alert("åå…¥ã‚’ä¿å­˜ã—ã¾ã—ãŸ"); loadStatus();
        }
        async function uploadCriteria() {
            const file = document.getElementById('criteriaInput').files[0];
            if(!file) return;
            const formData = new FormData();
            formData.append('file', file);
            await fetch('/api/settings/criteria', { method: 'POST', body: formData });
            alert("åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ"); loadStatus();
        }
    </script>
</body>
</html>
