<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æ”¿å‹™æ´»å‹•è²» è‡ªå‹•åˆ†åˆ¥ã‚¢ãƒ—ãƒª</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --secondary-color: #3b82f6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --text-color: #1f2937;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --border-color: #e5e7eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding-bottom: 80px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header p {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: 10px;
            padding: 5px;
            gap: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--text-color);
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 7px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .card h2 {
            font-size: 1.25rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .upload-area {
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #fafafa;
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary-color);
            background: #eff6ff;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        #fileInput {
            display: none;
        }

        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
        .preview-area {
            margin-top: 20px;
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-full {
            width: 100%;
        }

        /* é ˜åæ›¸ãƒªã‚¹ãƒˆ */
        .receipt-list {
            display: grid;
            gap: 15px;
        }

        .receipt-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
        }

        .receipt-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .receipt-store {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .receipt-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .receipt-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            font-size: 0.9rem;
            color: #6b7280;
        }

        .category-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #e0e7ff;
            color: #3730a3;
        }

        /* é›†è¨ˆç”»é¢ */
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-total {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .category-list {
            display: grid;
            gap: 12px;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .category-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .category-amount {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ã‚¢ãƒ©ãƒ¼ãƒˆ */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid var(--success-color);
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--danger-color);
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 640px) {
            .container {
                padding: 10px;
            }
            
            .receipt-details {
                grid-template-columns: 1fr;
            }
        }

        /* ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
        .export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“‹ æ”¿å‹™æ´»å‹•è²» ç®¡ç†</h1>
        <p>é ˜åæ›¸ã‚’æ’®å½±ã—ã¦è‡ªå‹•åˆ†é¡ãƒ»é›†è¨ˆ</p>
    </div>

    <div class="container">
        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="tabs">
            <button class="tab active" onclick="switchPage('home')">ğŸ  ãƒ›ãƒ¼ãƒ </button>
            <button class="tab" onclick="switchPage('register')">ğŸ“¸ ç™»éŒ²</button>
            <button class="tab" onclick="switchPage('list')">ğŸ“ å±¥æ­´</button>
            <button class="tab" onclick="switchPage('summary')">ğŸ“Š é›†è¨ˆ</button>
        </div>

        <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
        <div id="home" class="page active">
            <div class="card">
                <h2>ğŸ¯ ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹</h2>
                <p style="margin-bottom: 20px;">ã‚ˆãä½¿ã†æ©Ÿèƒ½ã«ç´ æ—©ãã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™</p>
                
                <div style="display: grid; gap: 15px;">
                    <button class="btn btn-primary btn-full" onclick="switchPage('register')">
                        ğŸ“¸ æ–°ã—ã„é ˜åæ›¸ã‚’ç™»éŒ²
                    </button>
                    <button class="btn btn-primary btn-full" onclick="switchPage('list')">
                        ğŸ“ ç™»éŒ²æ¸ˆã¿é ˜åæ›¸ã‚’ç¢ºèª
                    </button>
                    <button class="btn btn-primary btn-full" onclick="switchPage('summary')">
                        ğŸ“Š æœˆåˆ¥é›†è¨ˆã‚’è¡¨ç¤º
                    </button>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“Œ ä½¿ã„æ–¹</h2>
                <ol style="padding-left: 20px; line-height: 2;">
                    <li>ã€Œç™»éŒ²ã€ã‚¿ãƒ–ã‹ã‚‰é ˜åæ›¸ã‚’æ’®å½±ã¾ãŸã¯ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</li>
                    <li>AIãŒè‡ªå‹•ã§è²»ç›®ã‚’åˆ†é¡</li>
                    <li>å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§ä¿®æ­£</li>
                    <li>ã€Œé›†è¨ˆã€ã‚¿ãƒ–ã§æœˆåˆ¥ã®æ”¯å‡ºã‚’ç¢ºèª</li>
                    <li>CSV/PDFã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯èƒ½</li>
                </ol>
            </div>
        </div>

        <!-- ç™»éŒ²ç”»é¢ -->
        <div id="register" class="page">
            <div class="card">
                <h2>ğŸ“¸ é ˜åæ›¸ç™»éŒ²</h2>
                
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">ğŸ“·</div>
                    <p style="font-weight: 600; margin-bottom: 5px;">é ˜åæ›¸ã‚’æ’®å½±ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                    <p style="font-size: 0.875rem; color: #6b7280;">ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒã‚’é¸æŠ</p>
                </div>
                
                <input type="file" id="fileInput" accept="image/*" capture="environment">
                
                <div class="preview-area" id="previewArea" style="display: none;">
                    <img id="previewImage" class="preview-image" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
                </div>

                <div id="receiptForm" style="display: none; margin-top: 20px;">
                    <div class="form-group">
                        <label>åº—èˆ—å</label>
                        <input type="text" id="store" placeholder="ä¾‹: â—‹â—‹æ›¸åº—">
                    </div>

                    <div class="form-group">
                        <label>æ—¥ä»˜</label>
                        <input type="date" id="date">
                    </div>

                    <div class="form-group">
                        <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
                        <input type="number" id="total" placeholder="3500">
                    </div>

                    <div class="form-group">
                        <label>è²»ç›®</label>
                        <select id="category">
                            <option>èª¿æŸ»ç ”ç©¶è²»</option>
                            <option>ç ”ä¿®è²»</option>
                            <option>åºƒå ±è²»</option>
                            <option>åºƒè´è²»</option>
                            <option>è¦è«‹ãƒ»é™³æƒ…æ´»å‹•è²»</option>
                            <option>ä¼šè­°è²»</option>
                            <option>è³‡æ–™ä½œæˆè²»</option>
                            <option>è³‡æ–™è³¼å…¥è²»</option>
                            <option>äººä»¶è²»</option>
                            <option>äº‹å‹™æ‰€è²»</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>æŒ‰åˆ†ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="apportionment" value="100" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label>å‚™è€ƒ</label>
                        <textarea id="note" rows="3" placeholder="ä»»æ„"></textarea>
                    </div>

                    <button class="btn btn-success btn-full" onclick="saveReceipt()">
                        ğŸ’¾ ä¿å­˜ã™ã‚‹
                    </button>
                </div>
            </div>
        </div>

        <!-- å±¥æ­´ç”»é¢ -->
        <div id="list" class="page">
            <div class="card">
                <h2>ğŸ“ ç™»éŒ²å±¥æ­´</h2>
                
                <div class="form-group">
                    <label>æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                        <input type="number" id="filterYear" placeholder="å¹´ï¼ˆä¾‹: 2025ï¼‰">
                        <input type="number" id="filterMonth" placeholder="æœˆ">
                    </div>
                    <button class="btn btn-primary btn-full" style="margin-top: 10px;" onclick="loadReceipts()">
                        ğŸ” æ¤œç´¢
                    </button>
                </div>

                <div id="receiptList" class="receipt-list">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- é›†è¨ˆç”»é¢ -->
        <div id="summary" class="page">
            <div class="card">
                <h2>ğŸ“Š æœˆåˆ¥é›†è¨ˆ</h2>
                
                <div class="form-group">
                    <label>é›†è¨ˆæœŸé–“</label>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                        <input type="number" id="summaryYear" placeholder="å¹´ï¼ˆä¾‹: 2025ï¼‰">
                        <input type="number" id="summaryMonth" placeholder="æœˆ">
                    </div>
                    <button class="btn btn-primary btn-full" style="margin-top: 10px;" onclick="loadSummary()">
                        ğŸ“ˆ é›†è¨ˆ
                    </button>
                </div>

                <div id="summaryResult"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentImageData = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;

            // ç¾åœ¨ã®å¹´æœˆã‚’è¨­å®š
            const now = new Date();
            document.getElementById('filterYear').value = now.getFullYear();
            document.getElementById('filterMonth').value = now.getMonth() + 1;
            document.getElementById('summaryYear').value = now.getFullYear();
            document.getElementById('summaryMonth').value = now.getMonth() + 1;

            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) processFile(file);
            });
        });

        // ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
        function switchPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(pageName).classList.add('active');
            event.target.classList.add('active');

            if (pageName === 'list') loadReceipts();
            if (pageName === 'summary') loadSummary();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        async function processFile(file) {
            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImageData = e.target.result;
                document.getElementById('previewImage').src = currentImageData;
                document.getElementById('previewArea').style.display = 'block';
            };
            reader.readAsDataURL(file);

            // OCRå‡¦ç†
            showLoading('OCRå‡¦ç†ä¸­...');
            
            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/api/ocr/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    // ãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•å…¥åŠ›
                    document.getElementById('store').value = result.data.store;
                    document.getElementById('date').value = result.data.date;
                    document.getElementById('total').value = result.data.total;
                    document.getElementById('category').value = result.data.category;
                    
                    document.getElementById('receiptForm').style.display = 'block';
                    hideLoading();
                    
                    showAlert('âœ… OCRå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚', 'success');
                }
            } catch (error) {
                hideLoading();
                showAlert('âŒ OCRå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // é ˜åæ›¸ä¿å­˜
        async function saveReceipt() {
            const data = {
                user_id: 'default_user',
                date: document.getElementById('date').value,
                store: document.getElementById('store').value,
                category: document.getElementById('category').value,
                total: parseFloat(document.getElementById('total').value),
                note: document.getElementById('note').value,
                apportionment: parseFloat(document.getElementById('apportionment').value),
                image_url: currentImageData || ''
            };

            if (!data.date || !data.store || !data.total) {
                showAlert('âŒ å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            showLoading('ä¿å­˜ä¸­...');

            try {
                const response = await fetch(`${API_BASE}/api/receipt/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    showAlert('âœ… ä¿å­˜ã—ã¾ã—ãŸï¼ï¼ˆID: ' + result.receipt_id + 'ï¼‰', 'success');
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                    document.getElementById('receiptForm').reset();
                    document.getElementById('previewArea').style.display = 'none';
                    document.getElementById('receiptForm').style.display = 'none';
                    currentImageData = null;
                }
            } catch (error) {
                hideLoading();
                showAlert('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // é ˜åæ›¸ä¸€è¦§èª­ã¿è¾¼ã¿
        async function loadReceipts() {
            const year = document.getElementById('filterYear').value;
            const month = document.getElementById('filterMonth').value;
            
            showLoading('èª­ã¿è¾¼ã¿ä¸­...');

            try {
                const url = `${API_BASE}/api/receipt/list?user_id=default_user&year=${year}&month=${month}`;
                const response = await fetch(url);
                const result = await response.json();
                
                hideLoading();

                const listElement = document.getElementById('receiptList');
                
                if (result.receipts && result.receipts.length > 0) {
                    listElement.innerHTML = result.receipts.map(receipt => `
                        <div class="receipt-item">
                            <div class="receipt-header">
                                <div class="receipt-store">${receipt.store}</div>
                                <div class="receipt-amount">Â¥${receipt.total.toLocaleString()}</div>
                            </div>
                            <div class="receipt-details">
                                <div>ğŸ“… ${receipt.date}</div>
                                <div><span class="category-badge">${receipt.category}</span></div>
                                <div>ğŸ“‹ ID: ${receipt.receipt_id}</div>
                                <div>ğŸ“Š æŒ‰åˆ†: ${receipt.apportionment || 100}%</div>
                            </div>
                            ${receipt.note ? `<div style="margin-top: 8px; font-size: 0.875rem; color: #6b7280;">ğŸ’¬ ${receipt.note}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    listElement.innerHTML = '<p style="text-align: center; padding: 40px; color: #9ca3af;">ç™»éŒ²ã•ã‚ŒãŸé ˜åæ›¸ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                }
            } catch (error) {
                hideLoading();
                showAlert('âŒ èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // é›†è¨ˆèª­ã¿è¾¼ã¿
        async function loadSummary() {
            const year = parseInt(document.getElementById('summaryYear').value);
            const month = parseInt(document.getElementById('summaryMonth').value);
            
            showLoading('é›†è¨ˆä¸­...');

            try {
                const response = await fetch(`${API_BASE}/api/summary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: 'default_user', year, month })
                });

                const result = await response.json();
                hideLoading();

                const summaryElement = document.getElementById('summaryResult');
                
                if (result.success) {
                    const categories = Object.entries(result.by_category);
                    
                    summaryElement.innerHTML = `
                        <div class="summary-card">
                            <div style="font-size: 1rem; opacity: 0.9;">${result.period} åˆè¨ˆ</div>
                            <div class="summary-total">Â¥${result.total.toLocaleString()}</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">ç™»éŒ²ä»¶æ•°: ${result.receipt_count}ä»¶</div>
                        </div>

                        <div class="category-list">
                            ${categories.map(([category, amount]) => `
                                <div class="category-item">
                                    <div class="category-name">${category}</div>
                                    <div class="category-amount">Â¥${amount.toLocaleString()}</div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="export-buttons">
                            <a href="${API_BASE}/api/export/csv?user_id=default_user&year=${year}&month=${month}" 
                               class="btn btn-primary" download>
                                ğŸ“¥ CSV
                            </a>
                            <a href="${API_BASE}/api/export/pdf?user_id=default_user&year=${year}&month=${month}" 
                               class="btn btn-primary" download>
                                ğŸ“„ PDF
                            </a>
                        </div>
                    `;
                }
            } catch (error) {
                hideLoading();
                showAlert('âŒ é›†è¨ˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            }
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        function showLoading(message) {
            const loading = document.createElement('div');
            loading.id = 'loadingOverlay';
            loading.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>${message}</p>
                </div>
            `;
            loading.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; align-items: center; justify-content: center;';
            document.body.appendChild(loading);
        }

        function hideLoading() {
            const loading = document.getElementById('loadingOverlay');
            if (loading) loading.remove();
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; max-width: 90%; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.style.transition = 'opacity 0.3s';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
